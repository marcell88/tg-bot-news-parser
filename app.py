# app.py
import asyncio
import logging
import signal
from services.listener import main as run_listener
from services.cleaner import main as run_cleaner
from services.analyzer import main as run_analyzer
from services.finisher import main as run_finisher
from services.embedder import main as run_embedder
from services.tager import main as run_tager  # <-- Ð”ÐžÐ‘ÐÐ’Ð›Ð•Ð Ð˜ÐœÐŸÐžÐ Ð¢
from database.database import Database

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð²Ñ…Ð¾Ð´Ð°.
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

class ServiceManager:
    """ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÑÐµÐ¼Ð¸ ÑÐ»ÑƒÐ¶Ð±Ð°Ð¼Ð¸."""
    
    def __init__(self):
        self.tasks = []
        self.is_running = True
        
        # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð² Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
        signal.signal(signal.SIGINT, self._signal_handler)
        signal.signal(signal.SIGTERM, self._signal_handler)

    def _signal_handler(self, signum, frame):
        """ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð² Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸."""
        logging.info(f"ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ {signum}")
        self.is_running = False

    async def initialize_services(self):
        """Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²ÑÐµÑ… ÑÐ»ÑƒÐ¶Ð± Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼."""
        try:
            logging.info("ðŸ”„ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...")
            await Database.initialize_database()
            logging.info("âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°")
            return True
        except Exception as e:
            logging.critical(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð‘Ð”: {e}")
            return False

    async def start_services(self):
        """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð²ÑÐµ ÑÐ»ÑƒÐ¶Ð±Ñ‹."""
        services = [
            ("Listener", run_listener),
            ("Cleaner", run_cleaner), 
            ("Analyzer", run_analyzer),
            ("Finisher", run_finisher),
            ("Tager", run_tager),
            ("Embedder", run_embedder),
#            ("Stats", run_stats),
        ]
        
        for name, service_func in services:
            task = asyncio.create_task(self._run_service(name, service_func))
            self.tasks.append(task)
            await asyncio.sleep(1)  # ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ð¼Ð¸

    async def _run_service(self, name: str, service_func):
        """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð¾Ð´Ð½Ñƒ ÑÐ»ÑƒÐ¶Ð±Ñƒ Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº."""
        try:
            logging.info(f"ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐ»ÑƒÐ¶Ð±Ñ‹ {name}...")
            await service_func()
        except asyncio.CancelledError:
            logging.info(f"Ð¡Ð»ÑƒÐ¶Ð±Ð° {name} Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°")
        except Exception as e:
            logging.error(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÑÐ»ÑƒÐ¶Ð±Ðµ {name}: {e}")

    async def stop_services(self):
        """ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð²ÑÐµ ÑÐ»ÑƒÐ¶Ð±Ñ‹."""
        logging.info("ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… ÑÐ»ÑƒÐ¶Ð±...")
        for task in self.tasks:
            if not task.done():
                task.cancel()
        
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡
        if self.tasks:
            await asyncio.gather(*self.tasks, return_exceptions=True)
        
        # Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ñ Ð‘Ð”
        await Database.close()

    async def run(self):
        """ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ†Ð¸ÐºÐ» Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹."""
        try:
            # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ ÑÐ»ÑƒÐ¶Ð±
            if not await self.initialize_services():
                logging.critical("âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð‘Ð”. Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹.")
                return
                
            await self.start_services()
            
            # Ð”ÐµÑ€Ð¶Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼
            while self.is_running:
                await asyncio.sleep(1)
                
        except KeyboardInterrupt:
            logging.info("ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ KeyboardInterrupt")
        finally:
            await self.stop_services()

async def main_services():
    """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð²ÑÐµ ÑÐ»ÑƒÐ¶Ð±Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€."""
    manager = ServiceManager()
    await manager.run()

def start_application():
    """ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ."""
    logging.info("ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ...")
    
    try:
        asyncio.run(main_services())
    except KeyboardInterrupt:
        logging.info("ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ (Ctrl+C).")
    except Exception as e:
        logging.critical(f"ÐÐµÐ¿Ñ€ÐµÐ´Ð²Ð¸Ð´ÐµÐ½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² app.py: {e}")
    finally:
        logging.info("ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ.")

if __name__ == '__main__':
    start_application()